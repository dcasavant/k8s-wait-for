---
kind: Role
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: api-role
  namespace: default
  labels:
    app: tools-rbac
rules:
- apiGroups: ["", "batch"]
  resources: ["pods", "jobs"]
  verbs: ["get", "watch", "list"]
---
kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: global-rolebinding
  namespace: default
  labels:
    app: tools-rbac
subjects:
- kind: User
  name: system:serviceaccount:default:default
  apiGroup: rbac.authorization.k8s.io
  namespace: default
roleRef:
  kind: Role
  name: api-role
  apiGroup: rbac.authorization.k8s.io
---
apiVersion: v1
kind: Pod
metadata:
  name: myapp-pod
  labels:
    app: travis-example
spec:
  containers:
  - name: myapp-container
    image: busybox
    command: ['sh', '-c', 'echo The app is running! && sleep 60']
  initContainers:
  - name: init-container-under-test
    image: dcasavant/k8s-wait-for:test
    args: ["job",  "pi"]
---
apiVersion: batch/v1
kind: Job
metadata:
  name: pi
  labels:
    app: travis-example
spec:
  template:
    spec:
      containers:
      - name: pi
        image: alpine
        command: ['sh', '-c', 'sleep 10']
      restartPolicy: Never
  backoffLimit: 4
